#!/usr/bin/make

ROOT			:= $(CURDIR)
CDIR			:= $(ROOT)/C
STDDIR			:= $(ROOT)/std

CDIR_OUT		:= $(CDIR)/obj
STDDIR_OUT		:= $(STDDIR)/build

LIBAVSI			:= $(CDIR)/libavsi.a
STDBC			:= std/std.bc
# I have no ideas to resolve .o files generated by avsi automatically
# only listing them here
OBJS			:= \
$(STDDIR_OUT)/std/io.o \
$(STDDIR_OUT)/std/std.o

CC				:= $(ROOT)/../build/avsi

SYS_INCLUDE		:= /usr/include
SYS_LIB			:= /usr/lib

all:  $(LIBAVSI)

$(LIBAVSI): $(CDIR)/avsi.c $(STDDIR_OUT)/$(STDBC) $(OBJS)
	@echo "building libavsi"
	@make all -C $(CDIR)
	@echo "find objs: $(OBJS) "
	@ar -q $@ $(OBJS)

$(STDDIR_OUT)/$(STDBC): $(STDDIR)/__init__.sl
	@echo "building .bc file"
	@$(CC) $(STDDIR)/__init__.sl -m -o $(STDDIR_OUT)


.PHONY: clean
clean:
	@rm -f -r $(CDIR_OUT)
	@rm -f $(LIBAVSI)
	@rm -f -r $(STDDIR_OUT)

.PHONY: install
install:
	@if [ ! -d $(SYS_INCLUDE)/avsi ]; then mkdir $(SYS_INCLUDE)/avsi; fi
	@cp -rf $(STDDIR_OUT)/std $(SYS_INCLUDE)/avsi/std
	@cp -f $(LIBAVSI) $(SYS_LIB)/libavsi.a

.PHONY: uninstall
uninstall:
	@rm -f -r /usr/include/avsi
	@rm -f $(SYS_LIB)/libavsi.a